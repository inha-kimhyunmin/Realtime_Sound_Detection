🔍 소개
이 프로젝트는 실시간 오디오 녹음을 통해 환경 위험 소리(화재, 가스누출, 비명)를 감지하는 AI 기반 P### 실시간 감지
- 🎚️ **실시간 오디오 처리**: 연속적인 오디오 스트림 분석
- 🚨 **즉시 경고**: 위험 소리 감지시 실시간 알림
- 📊 **확### 실시간 감지 결과
```text
🎧 실시간 위험소리 감지 시스템 (YAMNet + LSTM)
📁 모델 로드: model_results_v1.2_20250808_143022/yamnet_lstm_model_v1.2.h5
🎯 클래스: ['무음', '정상(공장)', '화재', '가스누출', '비명']

🕒 2025-08-08 14:32:15
📊 예측 확률: [0.02 0.05 0.88 0.03 0.02]
🚨 위험 감지: 화재 (88.3% 확률)

🕒 2025-08-08 14:32:16  
📊 예측 확률: [0.01 0.03 0.02 0.92 0.02]
🚨 위험 감지: 가스누출 (92.1% 확률)
```래스별 확률값 표시
- 🕒 **시간 기록**: 감지 시점 정확한 기록
- ⚡ **병렬 처리**: 오디오 수집과 모델 추론 동시 진행 (새로운 방식)
- 🔄 **겹침 분석**: 세그먼트 간 겹침으로 연속성 보장 프로그램입니다.
YAMNet + LSTM 딥러닝 모델을 사용하여 5개 클래스(무음, 정상, 화재, 가스누출, 비명)를 분류하며, 
다양한 전환 시나리오를 포함한 종합적인 훈련을 통해 높은 정확도를 달성합니다.

📦 설치 방법
```bash
pip install tensorflow tensorflow-hub sounddevice librosa numpy scikit-learn soundfile
```

⚠️ 주요 의존성:
- TensorFlow 2.x
- TensorFlow Hub (YAMNet 모델)
- librosa (오디오 처리)
- sounddevice (실시간 녹음)
- scikit-learn (데이터 분석)
- soundfile (오디오 파일 입출력)

🚀 실행 방법

### 1. 모델 훈련
```bash
python LSTM_Train_5Class.py
```
5클래스 LSTM 모델을 훈련합니다. 결과물은 버전별 폴더(`model_results_v1.2_YYYYMMDD_HHMMSS`)에 저장됩니다.

### 2. 실시간 감지
```bash
python YAMNet+LSTM_Realtime_Detection.py
```
훈련된 모델을 사용하여 실시간으로 위험 소리를 감지합니다.

> 💡 **고성능 병렬 처리 버전**: `YAMNet_LSTM_Realtime_Parallel.py` 및 상세 설명은 [README_Parallel.md](README_Parallel.md)를 참조하세요.

### 3. 기존 Rule-based 방식 (참고용)
```bash
python realtime_environment_sound_detection.py
```
딥러닝 이전의 rule-based 감지 방식입니다.

⚙️ 주요 기능

### AI 모델 기반 감지
- 🧠 **YAMNet + LSTM 딥러닝 모델**: Google의 YAMNet 사전훈련 모델과 LSTM을 결합
- 🎯 **5클래스 분류**: 무음(0), 정상(1), 화재(2), 가스누출(3), 비명(4)
- 📊 **프레임 단위 분석**: 0.48초 단위로 세밀한 분석
- 🔄 **전환 시나리오 훈련**: 무음→공장소리, 무음→위험소리 전환 상황 학습

### 데이터 처리 및 훈련
- 🎤 **다양한 데이터 생성**: 무음, 정상, 전환, 위험소리 데이터 자동 생성
- ⚖️ **자동 가중치 계산**: 파일 개수 기반 클래스 균형 조정
- � **성능 분석**: 상세한 훈련 결과 보고서 자동 생성
- 💾 **버전 관리**: 모델별 결과물 체계적 저장

### 실시간 감지
- 🎚️ **실시간 오디오 처리**: 연속적인 오디오 스트림 분석
- � **즉시 경고**: 위험 소리 감지시 실시간 알림
- � **확률 기반 판단**: 각 클래스별 확률값 표시
- � **시간 기록**: 감지 시점 정확한 기록

🧠 AI 모델 구조 및 훈련 방식

### 모델 아키텍처
```
입력 오디오 (16kHz, 10초) 
    ↓
YAMNet 임베딩 추출 (1024차원)
    ↓
LSTM 레이어 (128 → 64 → 32 units)
    ↓
Dense 레이어 (64 → 32 units)
    ↓
출력 (5클래스 확률)
```

### 훈련 데이터 구성

#### 1. 기본 데이터 (v1.2 기준)
| 데이터 타입 | 샘플 수 | 설명 |
|-------------|---------|------|
| 무음 데이터 | 200개 | 완전무음 + 저음량 배경소음 |
| 정상 데이터 | 180개 | 공장소음만 |
| 무음→공장소리 전환 | 100개 | 현실적 전환 시나리오 |
| 무음→위험소리 전환 | 90개 | 긴급상황 시나리오 |

#### 2. 위험소리 데이터 (자동 가중치)
각 클래스당 목표 250샘플로 파일 개수 기반 자동 계산:
- **화재**: 파일 개수에 따라 자동 조정
- **가스누출**: 파일 개수에 따라 자동 조정  
- **비명**: 파일 개수에 따라 자동 조정

#### 3. 전환 데이터 특징
- **무음→공장소리**: 전체 길이의 20~80% 지점에서 0.5초 페이드인
- **무음→위험소리**: 전체 길이의 20~60% 지점에서 0.3초 페이드인
- **볼륨 정규화**: 현실적인 음량 비율 적용
- **라벨링**: 프레임별 정확한 클래스 할당

### 균형잡힌 클래스 분포 (v1.2)
| 클래스 | 예상 샘플 수 | 비율 |
|--------|-------------|------|
| 무음 | ~290개 | 22% |
| 정상 | ~280개 | 21% |
| 화재 | ~280개 | 21% |
| 가스누출 | ~280개 | 21% |
| 비명 | ~280개 | 21% |

### 학습 설정
- **에포크**: 20회
- **배치 크기**: 8
- **최적화**: Adam (learning_rate=0.001)
- **콜백**: EarlyStopping, ReduceLROnPlateau
- **데이터 분할**: 훈련 60% / 검증 20% / 테스트 20%

🧪 출력 예시

### 모델 훈련 결과
```text
📊 위험 소음 파일 개수 분석:
----------------------------------------
  fire: 15개 파일
  gas: 12개 파일  
  scream: 20개 파일

🎯 목표: 각 클래스당 250개 샘플 생성
⚖️ 자동 계산된 가중치:
----------------------------------------
  fire: 17 (파일당 샘플 수)
  gas: 21 (파일당 샘플 수)
  scream: 13 (파일당 샘플 수)

총 데이터 샘플 수: 1331
클래스별 비율:
  무음: 22.1%
  정상(공장): 21.3%
  화재: 21.0%
  가스누출: 21.2%
  비명: 20.8%

테스트 정확도: 0.9423 (94.23%)
```

### 실시간 감지 결과
```text
🎧 실시간 위험소리 감지 시스템 (YAMNet + LSTM)
� 모델 로드: model_results_v1.2_20250808_143022/yamnet_lstm_model_v1.2.h5
🎯 클래스: ['무음', '정상(공장)', '화재', '가스누출', '비명']

🕒 2025-08-08 14:32:15
📊 예측 확률: [0.02 0.05 0.88 0.03 0.02]
� 위험 감지: 화재 (88.3% 확률)

🕒 2025-08-08 14:32:16  
📊 예측 확률: [0.01 0.03 0.02 0.92 0.02]
🚨 위험 감지: 가스누출 (92.1% 확률)
```
✏️ 설정 조정

### 훈련 데이터 가중치 조정
`LSTM_Train_5Class.py` 파일에서 다음 값들을 조정할 수 있습니다:

```python
# 기본 데이터 샘플 수
SILENCE_SAMPLES = 200      # 무음 데이터
NORMAL_SAMPLES = 180       # 정상(공장소음) 데이터  
TRANSITION_SAMPLES = 100   # 무음→공장소리 전환
DANGER_TRANSITION_SAMPLES = 90  # 무음→위험소리 전환

# 가중치 계산 방식
AUTO_WEIGHT_CALCULATION = True  # 자동 계산 vs 수동 설정

# 수동 설정시 가중치
MANUAL_DANGER_WEIGHTS = {
    'fire': 0.3,      # 화재: 확률적 샘플링 (30%)
    'gas': 20.5,      # 가스누출: 파일당 20.5개
    'scream': 12.7    # 비명: 파일당 12.7개
}
```

### 실시간 감지 설정
`YAMNet+LSTM_Realtime_Detection.py`에서 감지 임계값을 조정할 수 있습니다:

```python
DANGER_THRESHOLD = 0.7  # 위험 감지 확률 임계값 (70%)
RECORDING_DURATION = 3.0  # 녹음 길이 (초)
```
🧰 사용 기술
- **Python 3.8+**
- **TensorFlow 2.x** - 딥러닝 프레임워크
- **TensorFlow Hub** - YAMNet 사전훈련 모델
- **librosa** - 오디오 신호 처리
- **sounddevice** - 실시간 오디오 녹음
- **numpy** - 수치 연산
- **scikit-learn** - 머신러닝 도구
- **soundfile** - 오디오 파일 입출력

📌 참고사항
- **YAMNet**: Google의 사전훈련된 오디오 분류 모델 사용
- **샘플링 주파수**: 16kHz 고정
- **프레임 길이**: 0.48초 (YAMNet 기본값)
- **모델 저장**: HDF5 형식 (.h5)
- **버전 관리**: 타임스탬프 기반 폴더 생성

📁 주요 파일 구조
```
📂 Realtime_Sound_Detection/
├── 📄 LSTM_Train_5Class.py          # 5클래스 모델 훈련
├── 📄 YAMNet+LSTM_Realtime_Detection.py  # 실시간 감지
├── 📄 YAMNet_LSTM_Realtime_Parallel.py   # 실시간 감지 (병렬 처리)
├── 📄 README_Parallel.md            # 병렬 처리 상세 설명서
├── 📄 realtime_environment_sound_detection.py  # Rule-based 방식
├── 📂 envsound/                     # 위험소리 훈련 데이터
│   ├── 📂 fire/                     # 화재 소리
│   ├── 📂 gas/                      # 가스누출 소리
│   └── 📂 scream/                   # 비명 소리
├── 📂 mixture/                      # 공장소음 배경 데이터
└── 📂 model_results_v1.2_*/         # 훈련 결과물
    ├── 📄 yamnet_lstm_model_v1.2.h5
    ├── 📄 model_info_v1.2.pkl
    └── 📄 model_performance_v1.2.txt
```

## 📊 기술적 배경 정보

### YAMNet + LSTM 접근법의 장점
1. **사전훈련된 특징 추출**: YAMNet이 AudioSet에서 학습한 범용 오디오 특징 활용
2. **시계열 패턴 학습**: LSTM이 시간적 변화 패턴 학습으로 전환 상황 감지 
3. **종합적 훈련**: 다양한 전환 시나리오 포함으로 현실적 상황 대응
4. **자동 균형 조정**: 파일 개수 기반 가중치로 클래스 불균형 해결

### 모델 성능 개선 요소
- **전환 데이터**: 무음→위험소리 전환으로 급작스러운 상황 대응력 향상
- **페이드인 효과**: 현실적인 소리 전환 시뮬레이션
- **균형 잡힌 학습**: 각 클래스 21-22% 균등 분포로 편향 방지
- **프레임 단위 분석**: 0.48초 세밀한 시간 해상도

✅ AI 모델 vs Rule-based 비교
| 특징 | YAMNet + LSTM | Rule-based |
|------|---------------|------------|
| **정확도** | 높음 (94%+) | 중간 (조건부) |
| **적응성** | 높음 (학습 기반) | 낮음 (고정 규칙) |
| **전환 감지** | 우수 | 제한적 |
| **노이즈 내성** | 강함 | 약함 |
| **설정 복잡도** | 낮음 (자동) | 높음 (수동) |
| **처리 속도** | 빠름 | 매우 빠름 |
| **메모리 사용** | 많음 | 적음 |

---

## 📖 참고용: Rule-based 방식 정보
### Rule-based 감지 기준 (참고용)

#### 비명 소리 감지 기준
| 파라미터 | 기준값 | 설명 |
|----------|--------|------|
| rms | > 0.02 | 음량 크기 |
| centroid | > 3000 Hz | 스펙트럼 중심 (고음 여부) |
| flatness | < 0.3 | 소음 비율 (낮을수록 명확한 목소리) |
| zcr | > 0.15 | 고주파 성분 |
| hnr | > 10 | 음성의 조화도 (사람 목소리는 높음) |

#### 폭발 소리 감지 기준  
| 파라미터 | 기준값 | 설명 |
|----------|--------|------|
| rms | > 0.05 | 큰 음압 |
| peak | > 0.3 | 순간 최대 진폭 |
| flatness | > 0.4 | 폭발 소리는 평탄도가 높음 |
| onset strength | > 0.3 | 급격한 에너지 변화 |
| hnr | < 5 | 조화도 낮음 (비음성적 소리) |

### 오디오 파라미터 설명
| 파라미터 이름 | 설명 | 비명 소리와의 관계 | 폭발 소리와의 관계 |
| rms (Root Mean Square) | 오디오 에너지의 평균값 (음압의 크기) | 비명이 일반 말보다 세기 때문에 높음 | 폭발은 순간적으로 매우 높음 |
| peak | 순간 최대 음압 (절대값) | 비명도 클 수 있음 | 폭발은 보통 피크가 매우 높음 (임펄스적) |
| zcr (Zero Crossing Rate) | 오디오 신호가 0을 넘는 횟수 → 신호의 진동성 | 비명은 높은 고주파 성분 때문에 진동이 많음 | 폭발은 노이즈지만 지속적인 진동은 적음 |
| centroid (Spectral Centroid) | 주파수 에너지의 "중심 위치" → 고주파일수록 높음 | 고음 비명은 centroid가 높게 나옴 | 폭발도 넓게 퍼지긴 하지만 centroid는 중간 정도 |
| flatness (Spectral Flatness) | 주파수 분포가 얼마나 평평한지 (0=하모닉, 1=노이즈) | 비명은 하모닉 구조라 낮은 편 | 폭발은 노이즈성이라 높음 |
| bandwidth (Spectral Bandwidth) | 주파수 분포의 폭 (Hz) | 고주파 비명은 대역폭이 넓음 | 폭발도 전체 주파수에 걸쳐있어 넓음 |
| rolloff (Spectral Rolloff) | 에너지의 85~95%가 누적되는 주파수 경계 | 고주파가 많으면 rolloff가 높음 | 폭발은 고주파까지 포함되어 rolloff가 큼 |
| onset (Onset Strength) | 순간적인 에너지 변화 (음의 발생 강도) | 보통 중간~높음 | 폭발은 매우 빠른 에너지 증가로 onset 값이 큼 |
| hnr (Harmonic-to-Noise Ratio) | 소리에 포함된 조화 성분의 비율 (높을수록 "사람 목소리" 느낌) | 비명은 사람의 목소리 → HNR이 높음 | 폭발은 noise → HNR이 매우 낮음 (~0) |

✅ 파라미터 간 직관적 비교
| 파라미터 | 비명 소리 | 폭발 소리 |
|----------|-----------|-----------|
| 에너지 (rms) | 높음 | 매우 높음 |
| 피크 (peak) | 중간~높음 | 매우 높음 |
| 진동성 (zcr) | 높음 (고음 성분) | 중간 |
| 중심주파수 (centroid) | 높음 (~4kHz) | 중간 (~2kHz) |
| 주파수 분산 (bandwidth) | 넓음 | 매우 넓음 |
| 하모닉/노이즈 (flatness) | 낮음 (하모닉) | 높음 (노이즈) |
| 고주파 포함 정도 (rolloff) | 높음 | 매우 높음 |
| 에너지 변화 (onset) | 빠르지만 일정 | 매우 급격함 |
| 조화도 (hnr) | 높음 (10-20dB) | 낮음 (0-5dB) |

✅ 왜 이 파라미터들이 중요한가?
비명은 기본적으로 사람 음성의 특성을 가지며,
비정상적으로 크고 고주파 성분이 풍부한 음성이야.
→ 따라서 HNR, centroid, bandwidth, ZCR 등이 핵심 기준이 돼.

폭발은 광대역 노이즈 + 임펄스 같은 특성이 있어서,
매우 짧고 강하며 주파수가 넓게 분포해 있음.
→ 따라서 flatness, onset, rolloff, peak, rms가 중요해.

✅ 예시: 비명 vs 폭발 특징
| 예시 | HNR | Flatness | Onset | Centroid |
|------|-----|----------|-------|----------|
| 여성 비명 | 15 dB | 0.1 | 0.2 | 4500 Hz |
| 폭발 소리 | 3 dB | 0.5 | 0.5 | 2000 Hz |